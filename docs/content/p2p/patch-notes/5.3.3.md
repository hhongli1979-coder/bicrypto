# P2P v5.3.3

**Release Date:** December 6, 2025
**Tags:** BUG FIXES, PAYMENT METHODS, ESCROW, DISPUTES, BALANCE CALCULATIONS, OFFER CREATION

## Fixed

### Offer Creation - Currency Change Issues

- **Price Not Updating on Currency Change**: Fixed issue where changing currency in offer creation would keep the old currency's price
  - Price per currency now automatically updates to the new market price when changing currencies
  - Added pending currency change detection to wait for new price to load before updating
  - Auto-fills price field when switching from a currency with no price to one with a valid market price

- **Amount Adjustment Not Working After Currency Change**: Fixed "Automatically adjust amount to meet minimum" button not working after changing currencies
  - Now properly recalculates amount based on the new currency's price
  - Resets amount when currency changes to prevent invalid calculations

### Critical: Negative Balance Bug

- **Available Balance Going Negative**: Fixed issue where available asset balance could go negative after multiple trades and disputes
  - Added safe amount calculations using `Math.min()` and `Math.max(0, ...)` across all P2P endpoints
  - Prevents deducting more than available balance in all scenarios
  - Applied to: trade release, trade cancellation, dispute resolution, admin trade actions

### Payment Methods

- **Flexible Payment Details**: Replaced hardcoded bank fields with flexible metadata system
  - Payment methods now support dynamic key-value pairs for any payment type
  - Added `metadata: Record<string, string>` field to payment method model
  - Supports any payment type (bank, PayPal, crypto wallet, etc.) with custom fields
  - Payment details properly copied to trade when initiated

- **Payment Details Display**: Fixed trade payment details showing hardcoded values
  - Now dynamically displays actual seller payment method metadata
  - Shows all custom fields from the payment method configuration
  
### Dispute System

- **Open Dispute Button Error**: Fixed "Converting circular structure to JSON" error
  - Button was passing MouseEvent object directly to API call
  - Now properly uses DisputeDialog component to collect reason/description first

- **Admin Fee on Disputes**: Fixed escrow fee not being deducted when disputes are resolved
  - Platform commission now properly recorded for BUYER_WINS and SPLIT outcomes
  - Escrow fee deducted from disputed amount before crediting buyer
  - Transaction records created for all parties involved

## Improved

### Payment Method Management

- **Create Payment Method Dialog**: Enhanced with flexible metadata entry
  - Dynamic key-value field entry for payment details
  - Add/remove fields as needed (up to 20 fields)
  - Fields like Account Number, Email, Phone can be customized per method

- **Payment Method API**: Updated to handle metadata
  - POST endpoint sanitizes and stores metadata
  - PUT endpoint allows updating metadata
  - Metadata passed through to trade initiation

### Code Quality

- **Safe Amount Calculations**: Consistent pattern across all balance operations
  ```typescript
  const safeAmount = Math.min(requestedAmount, Math.max(0, availableBalance));
  ```

- **Metadata Type Safety**: Proper TypeScript typing for payment method metadata
  - `metadata?: Record<string, string>` type definition
  - Sanitization to ensure only string key-value pairs stored

## Database Changes

### p2pPaymentMethod Table

- **New Field**: `metadata` (JSON)
  - Stores flexible key-value pairs for payment details
  - Replaces need for hardcoded bank-specific fields
  - Nullable, parsed as object on retrieval